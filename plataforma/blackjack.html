<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackjack Lunabet</title>
<style>
  body {
    background: #222;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0; padding: 20px;
  }
  #saldo, #mensaje {
    margin: 15px 0;
    font-size: 18px;
  }
  #info-apuesta {
    margin-bottom: 20px;
  }
  input[type=number] {
    padding: 8px;
    font-size: 16px;
    width: 100px;
    border-radius: 6px;
    border: none;
    margin-right: 10px;
  }
  button {
    background: #ff3333;
    color: white;
    border: none;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  button:disabled {
    background: #aa0000;
    cursor: not-allowed;
  }
  #dealer, #jugador {
    margin: 20px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    min-height: 130px;
  }
  .carta {
    width: 80px;
    height: 120px;
    background: white;
    color: black;
    border-radius: 10px;
    border: 2px solid #444;
    font-weight: bold;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    opacity: 0;
    transform: translateY(-50px);
    transition: all 0.4s ease;
  }
  .carta.mostrar {
    opacity: 1;
    transform: translateY(0);
  }
  #controles button {
    margin: 10px 10px 0 0;
  }
</style>
</head>
<body>

<h1>Blackjack Lunabet</h1>
<div id="saldo">Saldo: $0</div>

<div id="info-apuesta">
  <input type="number" id="input-apuesta" placeholder="Apuesta" min="1" />
  <button id="btn-apostar">Apostar</button>
</div>

<div id="mensaje"></div>

<h2>Dealer</h2>
<div id="dealer"></div>

<h2>Jugador</h2>
<div id="jugador"></div>

<div id="controles" style="display:none;">
  <button id="btn-pedir">Pedir Carta</button>
  <button id="btn-plantar">Plantarse</button>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBDWxn28oXn04--DMwkzqMq00g_W-OYJ3g",
    authDomain: "lunabet-73609.firebaseapp.com",
    databaseURL: "https://lunabet-73609-default-rtdb.firebaseio.com",
    projectId: "lunabet-73609",
    storageBucket: "lunabet-73609.firebasestorage.app",
    messagingSenderId: "45582135337",
    appId: "1:45582135337:web:3cb9190e37827d9cc72c38",
    measurementId: "G-0XC4PX3HK9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let uid = null;
  let saldo = 0;
  let apuesta = 0;

  // Cartas y valores
  const palos = ["â™ ", "â™¥", "â™¦", "â™£"];
  const valores = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

  // Mano del jugador y dealer
  let manoJugador = [];
  let manoDealer = [];
  let juegoActivo = false;

  // UI elements
  const saldoDiv = document.getElementById("saldo");
  const mensajeDiv = document.getElementById("mensaje");
  const inputApuesta = document.getElementById("input-apuesta");
  const btnApostar = document.getElementById("btn-apostar");
  const dealerDiv = document.getElementById("dealer");
  const jugadorDiv = document.getElementById("jugador");
  const btnPedir = document.getElementById("btn-pedir");
  const btnPlantar = document.getElementById("btn-plantar");
  const controlesDiv = document.getElementById("controles");

  // Verificar usuario logueado
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      uid = user.uid;
      saldo = await cargarSaldo(uid);
      mostrarSaldo();
    }
  });

  async function cargarSaldo(uid) {
    const docRef = db.collection("usuarios").doc(uid);
    const docSnap = await docRef.get();
    if (docSnap.exists) {
      return docSnap.data().saldo || 1000;
    } else {
      await docRef.set({ saldo: 1000 });
      return 1000;
    }
  }

  async function actualizarSaldo(uid, nuevoSaldo) {
    const docRef = db.collection("usuarios").doc(uid);
    await docRef.update({ saldo: nuevoSaldo });
  }

  function mostrarSaldo() {
    saldoDiv.textContent = "Saldo: $" + saldo;
  }

  // Crear una baraja completa
  function crearBaraja() {
    let baraja = [];
    for (const palo of palos) {
      for (const valor of valores) {
        baraja.push({ palo, valor });
      }
    }
    return baraja;
  }

  // Barajar la baraja
  function barajar(baraja) {
    for (let i = baraja.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [baraja[i], baraja[j]] = [baraja[j], baraja[i]];
    }
    return baraja;
  }

  // Valor de una mano (considerando As)
  function valorMano(mano) {
    let total = 0;
    let ases = 0;
    for (const carta of mano) {
      if (["J", "Q", "K"].includes(carta.valor)) {
        total += 10;
      } else if (carta.valor === "A") {
        ases++;
        total += 11;
      } else {
        total += parseInt(carta.valor);
      }
    }
    while (total > 21 && ases > 0) {
      total -= 10;
      ases--;
    }
    return total;
  }

  // Crear el elemento carta en DOM
  function crearElementoCarta(carta) {
    const div = document.createElement("div");
    div.classList.add("carta");
    div.textContent = carta.valor + carta.palo;
    setTimeout(() => div.classList.add("mostrar"), 50); // animaciÃ³n
    return div;
  }

  // Mostrar manos en pantalla
  function mostrarManos(mostrarDealerCompleto = false) {
    dealerDiv.innerHTML = "";
    jugadorDiv.innerHTML = "";

    manoDealer.forEach((carta, i) => {
      const div = crearElementoCarta(carta);
      if (i === 0 && !mostrarDealerCompleto) {
        div.textContent = "ðŸ‚ "; // carta tapada
      }
      dealerDiv.appendChild(div);
    });

    manoJugador.forEach(carta => {
      jugadorDiv.appendChild(crearElementoCarta(carta));
    });
  }

  // Inicio juego
  let baraja = [];

  btnApostar.onclick = async () => {
    if (juegoActivo) return;

    apuesta = Number(inputApuesta.value);
    if (!apuesta || apuesta < 1) {
      mensajeDiv.textContent = "Ingresa una apuesta vÃ¡lida.";
      return;
    }
    if (apuesta > saldo) {
      mensajeDiv.textContent = "Saldo insuficiente.";
      return;
    }

    saldo -= apuesta;
    await actualizarSaldo(uid, saldo);
    mostrarSaldo();
    mensajeDiv.textContent = "";

    baraja = barajar(crearBaraja());
    manoJugador = [baraja.pop(), baraja.pop()];
    manoDealer = [baraja.pop(), baraja.pop()];

    mostrarManos(false);

    juegoActivo = true;
    controlesDiv.style.display = "block";
    btnApostar.disabled = true;
    inputApuesta.disabled = true;

    // Verificar blackjack
    const jugadorVal = valorMano(manoJugador);
    const dealerVal = valorMano(manoDealer);

    if (jugadorVal === 21) {
      // Paga 1.5x
      const ganancia = apuesta * 2.5; // saldo apostado + 1.5x
      saldo += ganancia;
      await actualizarSaldo(uid, saldo);
      mostrarSaldo();
      mensajeDiv.textContent = "Â¡Blackjack! Ganaste $" + ganancia;
      finalizarJuego();
    }
  };

  btnPedir.onclick = () => {
    if (!juegoActivo) return;

    manoJugador.push(baraja.pop());
    mostrarManos(false);

    const val = valorMano(manoJugador);
    if (val > 21) {
      mensajeDiv.textContent = "Te pasaste de 21. Perdiste.";
      finalizarJuego();
    }
  };

  btnPlantar.onclick = () => {
    if (!juegoActivo) return;

    // Mostrar dealer completo
    mostrarManos(true);

    // Dealer juega mientras menos de 17
    let dealerVal = valorMano(manoDealer);
    while (dealerVal < 17) {
      manoDealer.push(baraja.pop());
      mostrarManos(true);
      dealerVal = valorMano(manoDealer);
    }

    const jugadorVal = valorMano(manoJugador);

    if (dealerVal > 21 || jugadorVal > dealerVal) {
      const ganancia = apuesta * 2;
      saldo += ganancia;
      mensajeDiv.textContent = `Â¡Ganaste! Ganaste $${ganancia}`;
    } else if (jugadorVal === dealerVal) {
      saldo += apuesta; // empate devuelve la apuesta
      mensajeDiv.textContent = "Empate, recuperaste tu apuesta.";
    } else {
      mensajeDiv.textContent = "Perdiste la mano.";
    }

    actualizarSaldo(uid, saldo).then(() => mostrarSaldo());
    finalizarJuego();
  };

  function finalizarJuego() {
    juegoActivo = false;
    controlesDiv.style.display = "none";
    btnApostar.disabled = false;
    inputApuesta.disabled = false;
    manoJugador = [];
    manoDealer = [];
  }
</script>

</body>
</html>
