<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackjack Mejorado - Lunabet</title>
<style>
  body {
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center; padding: 20px;
    min-height: 100vh;
  }
  h1 { margin-bottom: 10px; }
  #saldo { margin-bottom: 20px; font-size: 1.3em; }
  #apuestaContainer {
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 10px;
  }
  #apuesta {
    width: 150px;
  }
  #cartasDealer, #cartasJugador {
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    width: 400px;
    min-height: 140px;
    margin-bottom: 20px;
    display: flex; gap: 12px;
    background: #222;
    justify-content: center;
  }
  .carta {
    width: 80px; 
    height: 120px;
    background: #eee;
    color: black;
    border-radius: 8px;
    display: flex; 
    justify-content: center; 
    align-items: center;
    font-weight: bold;
    font-size: 2em;
    user-select: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.7);
  }
  #mensajes {
    min-height: 28px;
    margin-bottom: 15px;
    font-weight: bold;
    font-size: 1.2em;
    text-align: center;
  }
  button {
    background: #ff3333;
    border: none;
    padding: 12px 28px;
    color: white;
    font-weight: bold;
    margin: 5px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.3s;
  }
  button:disabled {
    background: #660000;
    cursor: not-allowed;
  }
  #acciones {
    margin-bottom: 30px;
  }
</style>
</head>
<body>

<h1>Blackjack Mejorado</h1>
<div id="saldo">Saldo: $<span id="saldoValor">1000</span></div>

<div id="apuestaContainer">
  <label for="apuesta">Apuesta:</label>
  <input type="range" id="apuesta" min="10" max="500" step="10" value="10" />
  <span id="apuestaValor">$10</span>
</div>

<div>
  <div><strong>Dealer:</strong></div>
  <div id="cartasDealer"></div>
</div>

<div>
  <div><strong>Jugador:</strong></div>
  <div id="cartasJugador"></div>
</div>

<div id="mensajes"></div>

<div id="acciones">
  <button id="btnPedir" disabled>Pedir Carta</button>
  <button id="btnPlantarse" disabled>Plantarse</button>
  <button id="btnDoblar" disabled>Doblar</button>
  <button id="btnDividir" disabled>Dividir</button>
  <button id="btnReiniciar" style="display:none;">Nueva Mano</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBDWxn28oXn04--DMwkzqMq00g_W-OYJ3g",
    authDomain: "lunabet-73609.firebaseapp.com",
    databaseURL: "https://lunabet-73609-default-rtdb.firebaseio.com",
    projectId: "lunabet-73609",
    storageBucket: "lunabet-73609.firebasestorage.app",
    messagingSenderId: "45582135337",
    appId: "1:45582135337:web:3cb9190e37827d9cc72c38",
    measurementId: "G-0XC4PX3HK9"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "../login.html";
    }
  });

  let saldo = localStorage.getItem('saldo') ? parseInt(localStorage.getItem('saldo')) : 1000;
  let apuesta = parseInt(document.getElementById('apuesta').value);
  let manoJugador = [];
  let manoDealer = [];
  let manoDividida = null; 
  let turnoMano = 'principal';
  let puedeDividir = false;
  let estadoJuego = 'esperando';

  const saldoValor = document.getElementById('saldoValor');
  const apuestaSlider = document.getElementById('apuesta');
  const apuestaValor = document.getElementById('apuestaValor');
  const cartasJugador = document.getElementById('cartasJugador');
  const cartasDealer = document.getElementById('cartasDealer');
  const mensajes = document.getElementById('mensajes');
  const btnPedir = document.getElementById('btnPedir');
  const btnPlantarse = document.getElementById('btnPlantarse');
  const btnDoblar = document.getElementById('btnDoblar');
  const btnDividir = document.getElementById('btnDividir');
  const btnReiniciar = document.getElementById('btnReiniciar');

  function actualizarSaldo(nuevoSaldo) {
    saldo = nuevoSaldo;
    localStorage.setItem('saldo', saldo);
    saldoValor.textContent = saldo;
  }

  function crearBaraja() {
    const palos = ['♠', '♥', '♦', '♣'];
    const valores = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let baraja = [];
    for (let palo of palos) {
      for (let val of valores) {
        baraja.push(val + palo);
      }
    }
    return baraja.sort(() => Math.random() - 0.5);
  }

  let baraja = [];

  function valorCarta(carta) {
    const valor = carta.slice(0, carta.length-1);
    if (['J','Q','K'].includes(valor)) return 10;
    if (valor === 'A') return 11;
    return parseInt(valor);
  }

  function valorMano(mano) {
    let total = 0;
    let ases = 0;
    mano.forEach(c => {
      const val = valorCarta(c);
      total += val;
      if (c.startsWith('A')) ases++;
    });
    while (total > 21 && ases > 0) {
      total -= 10;
      ases--;
    }
    return total;
  }

  function mostrarCartas(mano, contenedor) {
    contenedor.innerHTML = '';
    mano.forEach(carta => {
      const div = document.createElement('div');
      div.className = 'carta';
      div.textContent = carta;
      contenedor.appendChild(div);
    });
  }

  function iniciarMano() {
    if (apuesta > saldo) {
      mensajes.textContent = 'No tienes saldo suficiente para esa apuesta.';
      return;
    }
    baraja = crearBaraja();
    manoJugador = [];
    manoDealer = [];
    manoDividida = null;
    turnoMano = 'principal';
    estadoJuego = 'jugando';
    actualizarSaldo(saldo - apuesta);
    mensajes.textContent = 'Mano iniciada. Buena suerte!';
    btnReiniciar.style.display = 'none';

    manoJugador.push(baraja.pop());
    manoDealer.push(baraja.pop());
    manoJugador.push(baraja.pop());
    manoDealer.push(baraja.pop());

    // Mostrar cartas completas del dealer
    mostrarCartas(manoJugador, cartasJugador);
    mostrarCartas(manoDealer, cartasDealer);

    btnPedir.disabled = false;
    btnPlantarse.disabled = false;
    btnDoblar.disabled = false;
    btnDividir.disabled = (manoJugador[0].slice(0,-1) !== manoJugador[1].slice(0,-1));

    if (valorMano(manoJugador) === 21) {
      terminarMano(true);
    }
  }

  function pedirCarta() {
    if (estadoJuego !== 'jugando') return;
    manoJugador.push(baraja.pop());
    mostrarCartas(manoJugador, cartasJugador);
    if (valorMano(manoJugador) > 21) {
      terminarMano(false);
    }
  }

  function plantarse() {
    if (estadoJuego !== 'jugando') return;
    while (valorMano(manoDealer) < 17) {
      manoDealer.push(baraja.pop());
      mostrarCartas(manoDealer, cartasDealer);
    }
    terminarMano(false);
  }

  function doblar() {
    if (estadoJuego !== 'jugando') return;
    if (apuesta*2 > saldo + apuesta) {
      mensajes.textContent = 'No tienes saldo para doblar.';
      return;
    }
    actualizarSaldo(saldo - apuesta);
    apuesta *= 2;
    apuestaValor.textContent = '$' + apuesta;
    pedirCarta();
    if (valorMano(manoJugador) <= 21) {
      plantarse();
    }
    btnDoblar.disabled = true;
    btnDividir.disabled = true;
  }

  function dividir() {
    if (estadoJuego !== 'jugando') return;
    if (manoJugador.length !== 2) return;
    if (manoJugador[0].slice(0,-1) !== manoJugador[1].slice(0,-1)) {
      mensajes.textContent = 'No puedes dividir cartas diferentes.';
      return;
    }
    if (apuesta*2 > saldo + apuesta) {
      mensajes.textContent = 'No tienes saldo para dividir.';
      return;
    }
    actualizarSaldo(saldo - apuesta);
    manoDividida = [manoJugador.pop()];
    manoJugador.push(baraja.pop());
    manoDividida.push(baraja.pop());

    mostrarCartas(manoJugador, cartasJugador);
    // No mostramos mano dividida por simplicidad

    mensajes.textContent = 'Mano dividida (solo jugamos mano principal por ahora)';
    btnDividir.disabled = true;
    btnDoblar.disabled = true;
  }

  function terminarMano(blackjack) {
    estadoJuego = 'finalizado';
    btnPedir.disabled = true;
    btnPlantarse.disabled = true;
    btnDoblar.disabled = true;
    btnDividir.disabled = true;
    btnReiniciar.style.display = 'inline-block';

    mostrarCartas(manoDealer, cartasDealer);

    const valorJugador = valorMano(manoJugador);
    const valorDealer = valorMano(manoDealer);

    if (blackjack) {
      const ganancia = Math.floor(apuesta * 1.5);
      actualizarSaldo(saldo + apuesta + ganancia);
      mensajes.textContent = `¡Blackjack! Ganaste $${ganancia}`;
      return;
    }
    if (valorJugador > 21) {
      mensajes.textContent = 'Te pasaste. Perdiste.';
      return;
    }
    if (valorDealer > 21) {
      actualizarSaldo(saldo + apuesta*2);
      mensajes.textContent = 'El dealer se pasó. Ganaste!';
      return;
    }
    if (valorJugador > valorDealer) {
      actualizarSaldo(saldo + apuesta*2);
      mensajes.textContent = 'Ganaste la mano!';
      return;
    }
    if (valorJugador === valorDealer) {
      actualizarSaldo(saldo + apuesta);
      mensajes.textContent = 'Empate, recuperaste tu apuesta.';
      return;
    }
    mensajes.textContent = 'Perdiste la mano.';
  }

  btnReiniciar.onclick = () => {
    apuesta = parseInt(apuestaSlider.value);
    apuestaValor.textContent = '$' + apuesta;
    mensajes.textContent = '';
    iniciarMano();
  };

  apuestaSlider.oninput = () => {
    apuesta = parseInt(apuestaSlider.value);
    apuestaValor.textContent = '$' + apuesta;
  };
  btnPedir.onclick = pedirCarta;
  btnPlantarse.onclick = plantarse;
  btnDoblar.onclick = doblar;
  btnDividir.onclick = dividir;

  actualizarSaldo(saldo);
  apuestaValor.textContent = '$' + apuesta;
  mensajes.textContent = 'Ajusta tu apuesta y presiona "Nueva Mano" para empezar.';
  btnReiniciar.style.display = 'inline-block';
</script>

</body>
</html>

