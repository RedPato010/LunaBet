<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blackjack - Lunabet</title>
<style>
  body {
    background: url('fondo-mesa.jpg') center/cover no-repeat;
    background-color: #095228;
    font-family: Arial, sans-serif;
    color: white;
    margin: 0; padding: 0;
  }
  .contenedor {
    max-width: 480px;
    margin: auto;
    padding: 20px;
    background: rgba(0,0,0,0.6);
  }
  h1, h2 {
    text-align: center;
    margin-bottom: 8px;
  }
  #saldo, #apuesta, #mensaje {
    text-align: center;
    margin: 8px 0;
    font-size: 18px;
    font-weight: bold;
  }
  #acciones, #info-apuesta, #dealer, #jugador {
    text-align: center;
    margin: 10px 0;
  }
  input, button {
    font-size: 16px;
    padding: 8px;
    border: none;
    border-radius: 5px;
  }
  input[type=number] { width: 100px; }
  button {
    background: #ff3333;
    color: white;
    margin: 0 5px 8px 5px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:disabled { background: #660000; cursor: not-allowed; }
  #btn-agregarSaldo { background: #33cc33; margin: 10px 0; }
  .mano {
    display: flex;
    justify-content: center;
    gap: 6px;
    min-height: 90px;
    margin-bottom: 6px;
  }
  .carta {
    width: 60px;
    height: 90px;
    border-radius: 5px;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 4px;
    font-weight: bold;
    position: relative;
    opacity: 0; transform: translateY(-30px);
    transition: all 0.4s ease;
  }
  .carta.mostrar {
    opacity: 1;
    transform: translateY(0);
  }
  .score {
    font-size: 16px;
    margin-top: 4px;
  }
</style>
</head>
<body>

<div class="contenedor">
  <h1>♠ Blackjack ♠</h1>
  <div id="saldo">Saldo: $0</div>
  <button id="btn-agregarSaldo">+ $1000 para pruebas</button>

  <div id="apuesta">Apuesta: $0</div>
  <div id="info-apuesta">
    <input type="number" id="input-apuesta" placeholder="Apostar $" min="1">
    <button id="btn-apostar">Apostar</button>
  </div>

  <h2>Dealer <span id="score-dealer" class="score"></span></h2>
  <div id="dealer" class="mano"></div>

  <h2>Jugador <span id="score-jugador" class="score"></span></h2>
  <div id="jugador" class="mano"></div>

  <div id="acciones">
    <button id="btn-pedir" disabled>Pedir</button>
    <button id="btn-plantarse" disabled>Plantarse</button>
    <button id="btn-doblar" disabled>Doblar</button>
    <button id="btn-dividir" disabled>Dividir</button>
  </div>

  <div id="mensaje"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const config = {
    apiKey: "...", authDomain: "...", projectId: "...",
    databaseURL: "...", storageBucket: "...",
    messagingSenderId: "...", appId: "...", measurementId: "..."
  };
  firebase.initializeApp(config);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let uid, saldo = 0, apuesta = 0;
  let deck = [], dealerCartas = [], jugadorCartas = [];
  let turnoJugador = false;

  const ui = {
    saldo: document.getElementById('saldo'),
    scoreDealer: document.getElementById('score-dealer'),
    scoreJugador: document.getElementById('score-jugador'),
    apuesta: document.getElementById('apuesta'),
    mensaje: document.getElementById('mensaje'),
    inputApuesta: document.getElementById('input-apuesta'),
    btnApostar: document.getElementById('btn-apostar'),
    btnPedir: document.getElementById('btn-pedir'),
    btnPlantarse: document.getElementById('btn-plantarse'),
    btnDoblar: document.getElementById('btn-doblar'),
    btnDividir: document.getElementById('btn-dividir'),
    btnAgregarSaldo: document.getElementById('btn-agregarSaldo'),
    manoDealer: document.getElementById('dealer'),
    manoJugador: document.getElementById('jugador')
  };

  auth.onAuthStateChanged(async user => {
    if (!user) return window.location.href = 'login.html';
    uid = user.uid;
    const doc = await db.collection('usuarios').doc(uid).get();
    saldo = doc.exists && doc.data().saldo >= 0 ? doc.data().saldo : 0;
    mostrarSaldo();
  });

  function mostrarSaldo() {
    ui.saldo.textContent = `Saldo: $${saldo}`;
  }

  async function cambiarSaldo(nuevoSaldo) {
    saldo = nuevoSaldo;
    await db.collection('usuarios').doc(uid).set({ saldo }, { merge: true });
    mostrarSaldo();
  }

  function crearDeck() {
    const palos = ['♠','♥','♦','♣'], vals=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const b = [];
    palos.forEach(p => vals.forEach(v => b.push({ valor:v,palo:p})));
    return b.sort(()=>Math.random()-0.5);
  }

  function valorMano(mano) {
    let t=0, a=0;
    mano.forEach(c => {
      if (['J','Q','K'].includes(c.valor)) t+=10;
      else if (c.valor==='A') { t+=11; a++ }
      else t+=+c.valor;
    });
    while (t>21 && a>0) { t-=10; a-- }
    return t;
  }

  function crearCartaDOM(c) {
    const d = document.createElement('div');
    d.className = 'carta';
    d.textContent = c.valor + c.palo;
    if (c.palo==='♥'||c.palo==='♦') d.style.color='red';
    setTimeout(()=>d.classList.add('mostrar'),50);
    return d;
  }

  function mostrarMano(div, mano, ocultarPrimera=false) {
    div.innerHTML = '';
    mano.forEach((c,i) => {
      if (ocultarPrimera && i===0)
        div.appendChild(crearCartaDOM({valor:'?',palo:''}));
      else
        div.appendChild(crearCartaDOM(c));
    });
  }

  function actualizarPuntajes() {
    ui.scoreDealer.textContent = `(${valorMano(dealerCartas)})`;
    ui.scoreJugador.textContent = `(${valorMano(jugadorCartas)})`;
  }

  function habilitarAccion(act) {
    ui.btnPedir.disabled = !act;
    ui.btnPlantarse.disabled = !act;
    ui.btnDoblar.disabled = !(act && apuesta*2 <= saldo+apuesta);
    ui.btnDividir.disabled = true;
  }

  ui.btnApostar.onclick = async () => {
    const v = +ui.inputApuesta.value;
    if (!v || v<1 || v>saldo) {
      ui.mensaje.textContent = v>saldo ? 'Saldo insuficiente' : 'Apuesta inválida';
      return;
    }
    apuesta = v;
    await cambiarSaldo(saldo - apuesta);
    deck = crearDeck();
    dealerCartas = [deck.pop(), deck.pop()];
    jugadorCartas = [deck.pop(), deck.pop()];
    mostrarMano(ui.manoDealer, dealerCartas, true);
    mostrarMano(ui.manoJugador, jugadorCartas);
    actualizarPuntajes();

    turnoJugador = true;
    habilitarAccion(true);
    ui.apuesta.textContent = `Apuesta: $${apuesta}`;
    ui.mensaje.textContent = '';
  };

  ui.btnPedir.onclick = () => {
    if (!turnoJugador) return;
    jugadorCartas.push(deck.pop());
    mostrarMano(ui.manoJugador, jugadorCartas);
    actualizarPuntajes();
    if (valorMano(jugadorCartas) > 21) terminoJuego();
  };

  ui.btnPlantarse.onclick = async () => {
    if (!turnoJugador) return;
    turnoJugador = false;
    mostrarMano(ui.manoDealer, dealerCartas, false);
    while (valorMano(dealerCartas) < 17) {
      dealerCartas.push(deck.pop());
      mostrarMano(ui.manoDealer, dealerCartas);
      await new Promise(r => setTimeout(r, 500));
    }
    terminoJuego();
  };

  ui.btnDoblar.onclick = async () => {
    if (!turnoJugador || apuesta*2 > saldo+apuesta) return;
    await cambiarSaldo(saldo - apuesta);
    apuesta *= 2;
    ui.apuesta.textContent = `Apuesta: $${apuesta}`;
    jugadorCartas.push(deck.pop());
    mostrarMano(ui.manoJugador, jugadorCartas);
    actualizarPuntajes();
    turnoJugador = false;
    terminoJuego();
  };

  async function terminoJuego() {
    turnoJugador = false;
    mostrarMano(ui.manoDealer, dealerCartas, false);
    actualizarPuntajes();

    const pj = valorMano(jugadorCartas), pd = valorMano(dealerCartas);
    let ganancia = 0;
    if (pj === 21 && jugadorCartas.length === 2) {
      ganancia = apuesta * 2.5;
      ui.mensaje.textContent = `Blackjack! Ganaste $${ganancia.toFixed(2)}`;
    } else if (pj > 21) {
      ui.mensaje.textContent = 'Te pasaste. Perdiste.';
    } else if (pd > 21 || pj > pd) {
      ganancia = apuesta * 2;
      ui.mensaje.textContent = `¡Ganaste! Ganaste $${ganancia}`;
    } else if (pj === pd) {
      ganancia = apuesta;
      ui.mensaje.textContent = 'Empate, se devuelve la apuesta.';
    } else {
      ui.mensaje.textContent = 'Perdiste la apuesta.';
    }

    if (ganancia > 0) await cambiarSaldo(saldo + ganancia);
    habilitarAccion(false);
    apuesta = 0;
  }

  ui.btnAgregarSaldo.onclick = async () => {
    await cambiarSaldo(saldo + 1000);
    ui.mensaje.textContent = 'Se agregaron $1000 al saldo para pruebas.';
  };
</script>

</body>
</html>
